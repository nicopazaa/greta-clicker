<!doctype html>
<html lang="no">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, user-scalable=no" />
  <title>GRETA Clicker — Touch</title>
  <style>
    :root{ --bg:#0b1220; --text:#e6eefc; --muted:#94a3b8; --accent:#22c55e; }
    *{ box-sizing:border-box; -webkit-tap-highlight-color:transparent; }
    html,body{ height:100% }
    body{
      margin:0; font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Arial;
      color:var(--text); background:radial-gradient(1000px 600px at 20% 10%, #0d1729, var(--bg));
      display:grid; place-items:center;
    }
    .app{ width:min(520px,100%); min-height:100svh; display:grid; grid-template-rows:auto 1fr auto; gap:12px; padding:16px 16px 24px; }
    .hud{ display:flex; justify-content:space-between; align-items:center; gap:8px; }
    .counter{ font-size:clamp(28px,6vw,40px); font-weight:800; letter-spacing:.5px; }
    .muted{ color:var(--muted); font-size:14px }
    .stage{
      position:relative; display:grid; place-items:center; overflow:hidden;
      background:#0a1224; border:1px solid #1c2a4a; border-radius:16px; min-height:420px;
      touch-action:manipulation;
    }
    canvas{ position:absolute; inset:0; width:100%; height:100%; pointer-events:none }
    .tap-target{ display:grid; place-items:center; user-select:none; -webkit-user-drag:none; }
    .tap-target img, .tap-target .fallback{
      width:min(68vw, 360px); height:auto; object-fit:contain; filter:drop-shadow(0 10px 24px rgba(0,0,0,.35));
    }
    .fallback{
      width:min(68vw, 320px); height:min(68vw, 320px); border-radius:50%;
      background:#13203a; border:2px solid #21365f; color:#9bd5ff; font-size:72px; font-weight:900;
      display:grid; place-items:center;
    }
    .fallback[hidden]{ display:none !important; }
    .bar{ display:flex; gap:8px; justify-content:space-between; flex-wrap:wrap; }
    button{
      border:0; border-radius:12px; padding:12px 14px; color:#06110b;
      background:linear-gradient(180deg,#86efac,#22c55e); font-weight:700; cursor:pointer;
      box-shadow:0 8px 20px rgba(0,0,0,.35);
    }
    button.danger{ background:linear-gradient(180deg,#fecaca,#ef4444); color:#230707 }
    #greta{ cursor:pointer; }
  </style>
</head>
<body>
  <main class="app" role="application" aria-label="GRETA Clicker Touch">
    <header class="hud">
      <div class="counter" id="score">0</div>
      <div class="muted" id="status">Lagrer…</div>
    </header>

    <section class="stage" id="stage" aria-live="polite">
      <canvas id="fx"></canvas>
      <div id="tap" class="tap-target" role="button" aria-label="Trykk for å telle">
        <img id="greta" alt="Greta" src="Greta.png"
             onerror="this.remove();document.getElementById('ph').hidden=false;">
        <div id="ph" class="fallback" hidden aria-hidden="true">G</div>
      </div>
    </section>

    <footer class="bar">
      <button id="share">Del score</button>
      <button id="reset" class="danger">Nullstill</button>
      <span class="muted">1 trykk = 1 poeng. Røyk ved hvert trykk.</span>
    </footer>
  </main>

  <script>
    // ---------- Persist ----------
    const KEY = "greta_touch_v1";
    const safeParse = (s, fb) => { try { return JSON.parse(s); } catch { return fb; } };
    const save = (data) => { try { localStorage.setItem(KEY, JSON.stringify(data)); setStatus("OK"); } catch { setStatus("lagring av"); } };
    const load = () => safeParse(localStorage.getItem(KEY), { score: 0 });

    // ---------- DOM ----------
    const $score = document.getElementById("score");
    const $status = document.getElementById("status");
    const $reset  = document.getElementById("reset");
    const $share  = document.getElementById("share");
    const $stage  = document.getElementById("stage");
    const $tap    = document.getElementById("tap");
    const $img    = document.getElementById("greta");
    const $fx     = document.getElementById("fx");
    function setStatus(s){ $status.textContent = s; }

    // ---------- State ----------
    const state = load();
    updateScore(0);

    // ---------- Canvas ----------
    const ctx = $fx.getContext("2d", { alpha: true });
    const DPR = Math.max(1, Math.min(2, window.devicePixelRatio || 1));
    function resizeCanvas(){
      const r = $stage.getBoundingClientRect();
      $fx.width  = Math.floor(r.width  * DPR);
      $fx.height = Math.floor(r.height * DPR);
      $fx.style.width = r.width + "px";
      $fx.style.height = r.height + "px";
      ctx.setTransform(DPR, 0, 0, DPR, 0, 0);
    }
    resizeCanvas();
    new ResizeObserver(resizeCanvas).observe($stage);

    // ---------- Tap handling (bildet er knappen) ----------
    let lastFire = 0;
    function fireTap(){ const n = performance.now(); if (n - lastFire < 120) return; lastFire = n; onTap(); }

    // Lytt direkte på bildet
    if ($img) {
      $img.addEventListener("pointerdown", fireTap, { passive: true });
      $img.addEventListener("touchstart", fireTap, { passive: true });
      $img.addEventListener("click", fireTap, { passive: true });
    }
    // Fallback på wrapper
    ["pointerdown","touchstart","click"].forEach(t=> $tap.addEventListener(t, fireTap, { passive:true }));

    // iOS dbl-tap zoom guard
    let lastTouch = 0;
    document.addEventListener("touchend",(e)=>{
      const now = Date.now();
      if (now - lastTouch < 350) e.preventDefault();
      lastTouch = now;
    }, {passive:false});

    function onTap(){
      updateScore(1);
      if ($img && $img.style) {
        $img.style.transform = "translateY(1px) scale(0.99)";
        setTimeout(()=>{ $img.style.transform = ""; }, 60);
      }
      const {x,y} = computeExhaustOrigin();
      emitBurst(x, y);
      try { navigator.vibrate && navigator.vibrate(8); } catch {}
    }

    function updateScore(delta){
      state.score = Math.max(0, (state.score || 0) + delta);
      $score.textContent = formatNumber(state.score);
      save(state);
    }

    function formatNumber(n){
      if (!Number.isFinite(n)) return "0";
      if (n < 1000) return String(n);
      const u = ["K","M","B","T"]; let i=-1;
      while(n>=1000 && i<u.length-1){ n/=1000; i++; }
      return n.toFixed(2)+u[i];
    }

    function computeExhaustOrigin(){
      const holder = ($img && $img.isConnected) ? $img : document.getElementById("ph");
      const r = holder.getBoundingClientRect();
      const s = $stage.getBoundingClientRect();
      const x = (r.right - s.left) + Math.min(24, r.width*0.06);
      const y = (r.top - s.top) + r.height * 0.45;
      return { x, y };
    }

    // ---------- Partikler ----------
    const particles = [];
    const RAND = (a,b)=> a + Math.random()*(b-a);
    const CLAMP = (n,min,max)=> Math.min(Math.max(n,min),max);

    function emitBurst(x, y){
      const N = 12;
      for(let i=0;i<N;i++){
        const ang  = RAND(-0.35, 0.35);
        const spd  = RAND(60, 130);
        const vx   = Math.cos(ang) * spd;
        const vy   = Math.sin(ang) * spd - RAND(10, 40);
        const life = RAND(0.6, 1.2);
        const r0   = RAND(4, 10);
        particles.push({ x, y, vx, vy, r:r0, rDec:RAND(3,7), a:RAND(0.5,0.8), aDec:RAND(0.6,1.2), t:0, life });
      }
    }

    let last = performance.now();
    function loop(now){
      const dt = CLAMP((now - last)/1000, 0, 0.05);
      last = now;
      ctx.clearRect(0,0,$fx.width,$fx.height);
      for(let i=particles.length-1;i>=0;i--){
        const p = particles[i]; p.t += dt;
        if (p.t > p.life){ particles.splice(i,1); continue; }
        p.x += p.vx * dt; p.y += p.vy * dt;
        p.vx *= 0.98; p.vy += 12 * dt;
        p.r = Math.max(0, p.r - p.rDec * dt);
        p.a = Math.max(0, p.a - p.aDec * dt);
        ctx.beginPath(); ctx.arc(p.x, p.y, p.r, 0, Math.PI*2); ctx.closePath();
        ctx.fillStyle = `rgba(180,185,190,${p.a})`; ctx.fill();
      }
      requestAnimationFrame(loop);
    }
    requestAnimationFrame(loop);

    // ---------- UI ----------
    $reset.addEventListener("click", ()=>{
      if (!confirm("Nullstille score?")) return;
      state.score = 0; updateScore(0);
    });

    $share.addEventListener("click", async ()=>{
      const text = `Min GRETA-score: ${$score.textContent}`;
      try{
        if (navigator.share) await navigator.share({ title:"GRETA Clicker", text, url: location.href });
        else { await navigator.clipboard.writeText(text + " " + location.href); alert("Kopiert til utklippstavle."); }
      }catch{}
    });
  </script>
</body>
</html>
